<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title> Allan&#39;s blog &middot; Allan&#39;s blog </title>

  
  <link rel="stylesheet" href="http://allan-simon.github.io/blog/css/poole.css">
  <link rel="stylesheet" href="http://allan-simon.github.io/blog/css/syntax.css">
  <link rel="stylesheet" href="http://allan-simon.github.io/blog/css/hyde.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">
  <link rel="stylesheet" href="https://yandex.st/highlightjs/8.0/styles/default.min.css">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.ico">

  
  <link href="http://allan-simon.github.io/blog/index.xml/" rel="alternate" type="application/rss+xml" title="Allan&#39;s blog" />
</head>

<body>

<div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1><a href="/blog">Allan&#39;s blog</a></h1>
      <p class="lead">
       Tips, tricks and random thoughts on Linux/Vim/rust/php/devops 
      </p>
    </div>

    <ul class="sidebar-nav">
      <li><a href="/blog/about">About</a> </li>
      
    </ul>

    <p>Â© Creative-Common attribution</p>
  </div>
</div>


<div class="content container">
<div class="posts">

      
  <div class="post">
    <h1 class="post-title">
      <a href="http://allan-simon.github.io/blog/posts/bug-in-vagrant-virtualbox-sharefolder/">
        bug in Vagrant with Virtualbox sharefolder
      </a>
    </h1>

    <span class="post-date">Sun, Aug 23, 2015</span>

    

<h2 id="toc_0">The problem: serving static files</h2>

<p>The problem will affect you if you try to serve static files
from your vagrant folder if you use the default from virtualbox</p>

<p>For example you got your nginx or apache to serve css files
and when you update them, they don&rsquo;t get updated, and sometimes
they even come out with some garbage bytes at the end of it</p>

<h2 id="toc_1">The reason, a long standing bug in virtual box</h2>

<p>after reading <a href="https://github.com/mitchellh/vagrant/issues/351">this bug report</a> in vagrant repository</p>

<p>I&rsquo;ve found that the underlying bug is from virtualbox, bug which has been reported <a href="https://www.virtualbox.org/ticket/12597">here</a></p>

<h2 id="toc_2">The solutions: deactivate send or switch of sharefolder type</h2>

<p>If you use Nginx or apache you can just followed the <a href="https://docs.vagrantup.com/v2/synced-folders/virtualbox.html">official workaround</a></p>

<p>In Nginx:</p>

<pre><code>sendfile off;
</code></pre>

<p>In Apache:</p>

<pre><code>EnableSendfile Off
</code></pre>

<p>If you are like me and you&rsquo;re serving your files from go then you have no
other choice than to swithc the sharefolder type, nfs for Unix-ish OS and
SMB for windows</p>

<p>A colleague of mine made this to have a transparent switch for your developers</p>

<pre><code>def host_box_is_unixy?
  (RUBY_PLATFORM !~ /cygwin|mswin|mingw|bccwin|wince|emx/)
end


Vagrant.configure(2) do |config|

   # your stuffs

  if host_box_is_unixy?
    config.vm.synced_folder &quot;./&quot;, &quot;/vagrant&quot;, type: &quot;nfs&quot;
  else
    config.vm.synced_folder &quot;./&quot;, &quot;/vagrant&quot;, type: &quot;smb&quot;, mount_options: ['ip=192.168.50.1'] #host side of :private_network
    config.vm.network &quot;private_network&quot;, ip: &quot;192.168.50.12&quot;
  end
</code></pre>

<p>NFS and SMB sharefolder don&rsquo;t have this bug so you should be fine with that</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://allan-simon.github.io/blog/posts/create-a-rest-api-with-symfony2-part2-entity-migration/">
        create a rest api with symfony2 Part 2: Entity,  DB Migration, CRUD
      </a>
    </h1>

    <span class="post-date">Sun, May 24, 2015</span>

    

<p>Update 23 November 2015: Corrected some typo, and updated bundles versions for Doctrine</p>

<p>In the <a href="http://allan-simon.github.io/blog/posts/create-a-rest-api-with-symfony2/">first part</a> we&rsquo;ve seen how to
create the base of a symfony2 project used to generate a REST Api.</p>

<p>In this part we&rsquo;re going to see</p>

<ul>
<li>How to use the basics of JMSSerializer to serialize Entity objects</li>
<li>How to link our API with a database</li>
<li>How to create migration files to easily manage our datase over time and colleagues</li>
<li>and how to generate a full <a href="https://en.wikipedia.org/wiki/Create,_read,_update_and_delete">CRUD (create/read/update/delete)</a> with form checking</li>
</ul>

<h4 id="toc_0">Very important Note /!\ (can save you hours of debugging):</h4>

<p>if at any moment you got some strange 500 errors, run</p>

<pre><code>php app/console cache:clear
php app/console cache:clear --env prod
</code></pre>

<p>as sometimes, especially when you change the configuration files, the production environment will not update directly all the files, creating some weird errors.</p>

<h3 id="toc_1">Creating the entity Article</h3>

<p>for the moment we will limit ourselves to one entity <code>Article</code> which will contain for the moment only:</p>

<ul>
<li>an id</li>
<li>a title =&gt; that can&rsquo;t be blank</li>
<li>a body =&gt; which is a very long text and can&rsquo;t be blank</li>
</ul>

<p>(we&rsquo;re going to see later how to add more attributes)</p>

<p>So we&rsquo;re going to create a class in <code>src/AppBundle/Entity/Article.php</code> (the class representing
1 article, it&rsquo;s put to singular, so please don&rsquo;t name it ArticleS) That will be used by Doctrine:</p>

<pre><code>&lt;?php

namespace AppBundle\Entity;

use Doctrine\ORM\Mapping as ORM;

/**
 * @ORM\Entity()
 */
class Article
{
    /**
     * @var int
     *
     * @ORM\Id
     * @ORM\Column(type=&quot;integer&quot;)
     */
    protected $id;

    /**
     * @var string
     *
     * @ORM\Column(type=&quot;string&quot;)
     */
    protected $title;

    /**
     * @var string
     *
     * @ORM\Column(type=&quot;string&quot;)
     */
    protected $body;

    /**
     * We'll see later why $title and $body are put by default to ''
     */
    public function __construct($title = '', $body = '')
    {

    }

    // Note: at the opposite of the bad habits contracted by those coming
    // from the Java world we don't generate all the setters and getters
    // brainlessly, otherwise you can simply put the properties as
    // public...
    // By not creating them we're sure:
    // that nobody can set the id
    // that we understand why and how we need to add getter and or
    // setter of a property
}
</code></pre>

<p>We&rsquo;re going to see soon the use of the <code>@ORM\...</code>, for the moment you just need to
know it&rsquo;s called <code>an annotation</code> and they come from <code>use Doctrine\ORM\Mapping as ORM</code>
(hence the ORM at the beginning of the annotation)</p>

<p>So now we can update our controller to generate an article instead</p>

<pre><code>      /**
       * ....
       * @return Article
       */
      public function getArticleAction($id)
      {
          return new Article(&quot;title $id&quot;, &quot;body $id&quot;);
      }   

</code></pre>

<p>Now if you refresh the page you will an error 500</p>

<pre><code>    &quot;message&quot;:&quot;Could not normalize object of type AppBundle\\Entity\\Article&quot;
</code></pre>

<p>it&rsquo;s because the very basic serializer of Symfony2 does not know how
to serialize an Entity object. For that we would need to have some Normalizer
as explained here <a href="http://symfony.com/doc/current/cookbook/serializer.html">http://symfony.com/doc/current/cookbook/serializer.html</a></p>

<p>But as we plan to cover more complex example latters, we will go directly
with a Serializer on steroid named JMSSerializer, its documentation being <a href="http://jmsyst.com/bundles/JMSSerializerBundle#usage">there</a></p>

<p>to install it</p>

<pre><code> composer require jms/serializer-bundle
</code></pre>

<p>you may need to increase the RAM of the virtual machine temporary
to do this add the lines:</p>

<pre><code>  config.vm.provider &quot;virtualbox&quot; do |v| 
    v.memory = 2048
  end 

</code></pre>

<p>and then run <code>vagrant reload</code> (it will restart the virtual machine)</p>

<p>once done you can activate the bundle in <code>app/AppKernel.php</code></p>

<pre><code>    // ...
    new JMS\SerializerBundle\JMSSerializerBundle(),
    // ...
</code></pre>

<p>And as the FOSRestBundle is already configured internally to look for the existence
of the JMSSerializer, and to use it in priority of the default symfony2 seralizer
you don&rsquo;t need to do anything more to get it working.</p>

<p>Now if you refresh the page you will see</p>

<pre><code>{
    &quot;title&quot;:&quot;title 1&quot;,
    &quot;body&quot;:&quot;body 1&quot;
}
</code></pre>

<p>Note: the <code>id</code> property is missing because it is currently set to null, every property
with the value null will not be seralized. In order to get an id, we need to save first
the object in database</p>

<h3 id="toc_2">Generate a database migration</h3>

<p>for the moment our database is empty (and existing as it was created during the <code>vagrant up</code>
if you check the provisionning folder , one of the file contains a task to create a database)</p>

<p>So in order to save our Articles in database we&rsquo;re going to need a table</p>

<p>DON&rsquo;T RUN TO GOOGLE on how to create a table manually, you don&rsquo;t need that, instead we&rsquo;re going to use
a <code>migration</code> tool =&gt; Doctrine Migration because:</p>

<ul>
<li>it will create automatically the SQL statement from our Entity class</li>
<li>it will create a file that our colleagues will be able to replay on their own machine (or in production) without any chance of typo or copy paste</li>
<li>it has a mechanism to be sure to not be run twice</li>
<li>it also automatically generate the SQL statment in the same file to &ldquo;revert&rdquo; your change if something goes wrong</li>
<li>it will always be the same command, regardless on how complicated your database changes are.</li>
<li>it knows SQL and the specific database you&rsquo;re using better than you.</li>
</ul>

<p>The full documentation can be found <a href="http://symfony.com/doc/current/bundles/DoctrineMigrationsBundle/index.html">here</a></p>

<p>In order to install it, you need to edit the composer.json and add this two lines in the <code>require</code> section</p>

<pre><code>        &quot;doctrine/migrations&quot;: &quot;1.0.*@dev&quot;,
        &quot;doctrine/doctrine-migrations-bundle&quot;: &quot;1.0.*&quot;
</code></pre>

<p>and then run <code>composer update</code></p>

<p>after that activate the bundle in <code>app/AppKernel.php</code></p>

<pre><code>        new Doctrine\Bundle\MigrationsBundle\DoctrineMigrationsBundle(),
</code></pre>

<p>then you can create migration file using</p>

<pre><code>php app/console doctrine:migrations:diff
</code></pre>

<p>if everything goes well you should see</p>

<pre><code>vagrant@vagrant-ubuntu-trusty-64:/vagrant/MyApplication$ php app/console doctrine:migrations:diff 
Generated new migration class to &quot;/vagrant/MyApplication/app/DoctrineMigrations/Version20150524202209.php&quot; from schema differences.
</code></pre>

<p>(the number will vary as it&rsquo;s generated from current date)</p>

<p>if you got any error message, check in priority your <code>app/config/parameters.yml</code> to see if the driver is correctly set to <code>pdo_pgsql</code> and the username password set to <code>vagrant</code> (or the ones you&rsquo;ve chosen)</p>

<p>if you open the file you will it contains a SQL request, you can apply it by doing</p>

<pre><code>php app/console doctrine:migrations:migrate
</code></pre>

<p>Note: from now that&rsquo;s the only two commands you need to update your databases 99% of the time. If you need to do additional SQL request, you can always edit the file <strong>BEFORE</strong> committing it AND before applying it, and on the other sides, your colleagues only need to run the migrate command.</p>

<p>Note2: the migrate command can be run safely as many times as you want, so it can be run everytime you have a doubt that your database schema is up to date.</p>

<p>Note3: the migrate command will run all the migrations that are not run yet on your machine, regardless on how are missing.</p>

<h3 id="toc_3">Save an article in database</h3>

<p>For the sake of the example, for the moment we create the Article entity on the fly at each request, now we&rsquo;re going to persist it in database before serialization (i.e before the <code>return</code> of the controller) in order to get an Id.</p>

<p>Of course later we&rsquo;re going to move the Article creation to a dedicated API call</p>

<p>For that we&rsquo;re going to need the <code>Doctrine</code> object (i.e the PHP library used to manage database and to map database rows and object,  tables and classes, i.e the <a href="https://en.wikipedia.org/wiki/Object-relational_mapping">ORM</a></p>

<p>Symfony2 already create this object and link it to the database for us, in order to access to it, we need to make our service inheriting from the the <code>FOSRestController</code> class like this</p>

<pre><code>&lt;?php

namespace AppBundle\Controller;

use FOS\RestBundle\Controller\FOSRestController;

class ArticlesController extends FOSRestController
{
...
}

</code></pre>

<p>Then we can access to the <code>Entity Manager</code> (i.e the object that take care of saving and keeping in sync the PHP objects and the SQL database) by using <code>$this-&gt;getDoctrine()-&gt;getManager()</code>, and then saving our object like this</p>

<pre><code>      public function getArticleAction($id)
      {   
          $article = new Article(&quot;title $id&quot;, &quot;body $id&quot;);
  
          $manager = $this-&gt;getDoctrine()-&gt;getManager();
          // persist ONLY add the object to the list of object to
          // save
          $manager-&gt;persist($article);
          // only flush will actually save in database, this in order
          // to make it possible to save a lot of object in only one flush
          // (which is a LOT faster than flushing one by one
          $manager-&gt;flush();
  
          return $article;
     }

</code></pre>

<p>Then if you try to refresh the page <code>/api/articles/1</code> it will now generate you an error, saying it can&rsquo;t save in database because of the field <code>id</code> of Article, because we forgot to set it as autoincremented, in order to change that it&rsquo;s extremly simple , add the line <code>* @ORM\GeneratedValue</code> in the Entity:</p>

<pre><code>      /*
       * ....
       * @ORM\GeneratedValue
       */
      protected $id;

</code></pre>

<p>and now you can do a <code>diff</code> and <code>migrate</code> as explained above.</p>

<p>Now refresh the page you should see:</p>

<pre><code>{&quot;id&quot;:1,&quot;title&quot;:&quot;title 1&quot;,&quot;body&quot;:&quot;body 1&quot;}
</code></pre>

<p>if you refesh again, you will see</p>

<pre><code>{&quot;id&quot;:2,&quot;title&quot;:&quot;title 1&quot;,&quot;body&quot;:&quot;body 1&quot;}
</code></pre>

<p>this is because we&rsquo;re creating a new Article everytime.</p>

<p>So let&rsquo;s clean that</p>

<h3 id="toc_4">Retrieve an article from database</h3>

<h4 id="toc_5">The normal way (using the repository)</h4>

<p>Now that we have some Article in database (accidentally created by our previous code), it&rsquo;s time to clean <code>GET /api/articles/{id}</code> to actually works as expected</p>

<p>for this you can retrieve it by doing</p>

<pre><code>      public function getArticleAction($id)
      {   
          $article = $this
              -&gt;getDoctrine()
              -&gt;getRepository('AppBundle:Article')
              -&gt;find($id);
  
          return $article;
     }
</code></pre>

<p>The <code>getRepository('AppBundle:Article')</code> is used to retrieve the Repository, which is the object used to generate the SQL request for you, in order to retrieve data, there&rsquo;s one repository by table/class, in order to get the right one easily, you can simply use the string <code>BundleName:ClassName</code> so in our case <code>AppBundle:Article</code></p>

<p>Then the <code>find</code> method is used to take an id, and retrieve one element, or null if it does not exists</p>

<p>It means that you have to handle the <code>404 not found</code> yourself (the <code>404</code> status code bein if you remember your reading of part 1, the code to say that a Resource can&rsquo;t be found)</p>

<p>for that simply add</p>

<pre><code>
    public function getArticleAction($id)
    {   
        $article = $this
            -&gt;getDoctrine()
            -&gt;getRepository('AppBundle:Article')
            -&gt;find($id);

        if (is_null($article)) {
            throw $this-&gt;createNotFoundException('No such article');
        } 
  
        return $article;
     }
</code></pre>

<p>and now checking for a non existing article id will correctly return you a 404</p>

<h4 id="toc_6">The simpler way (using the auto mapping of arguments)</h4>

<p>As retrieving an object from the id given in parameters is a very common operation, symfony2
already have something to makes your lifes easier, if instead of giving the parameters <code>$id</code>
you directly put the parameters with the type you need, Symfony2 will automatically try to
find the article with the corresponding id (and return the 404 <strong>BEFORE</strong> calling your method)</p>

<p>so now your code will only be:</p>

<pre><code>    public function getArticleAction(Article $article)
    {
        return $article
    }
</code></pre>

<p>much simpler uh ? and the 404 case is still handle</p>

<h3 id="toc_7">Implementing GET /api/articles</h3>

<p>In order to get all articles, the standard REST way to do that is simply to remove the <code>{id}</code> part,
which can directly be done with symfony2 by adding this method <code>getArticlesAction</code> (notice the S), and using the method <code>findAll()</code> of the repository,</p>

<p>the API will then always return an array, either empty, or of Articles, serialized the same way as when you get one</p>

<pre><code>      /**
S&gt;     * retrieve all articles
       * TODO: add pagination
       *
       * @return Article[]
       */
      public function getArticlesAction()
      {
          $articles = $this
              -&gt;getDoctrine()
              -&gt;getRepository('AppBundle:Article')
              -&gt;findAll();
  
          return $articles;
      }
</code></pre>

<p>and that&rsquo;s all</p>

<p>now calling <code>/api/articles</code> will give you</p>

<pre><code>[
    {&quot;id&quot;:1,&quot;title&quot;:&quot;title 1&quot;,&quot;body&quot;:&quot;body 1&quot;},
    {&quot;id&quot;:2,&quot;title&quot;:&quot;title 1&quot;,&quot;body&quot;:&quot;body 1&quot;}
]
</code></pre>

<h4 id="toc_8">Important Note concerning pagination:</h4>

<p>Pagination being a little more complex topic, we will cover it in a later part
However if you remember your reading of Part1, pagination belongs to the metadata
of the resource, so they belongs to the header of the HTTP response, which means
that when pagination will be implemented, the json returned will still looks like
that which permit</p>

<ul>
<li>to implement only one parser on client side for list, regardless of paginated or not</li>
<li>permit a better flexibility and retro compatibility even if you &ldquo;ooops forgot pagination&rdquo; or you latter decide to remove it to simplify your API</li>
</ul>

<h3 id="toc_9">Implement POST /articles (creating one new article)</h3>

<p>Note: of course never use GET to create (or edit) a resource, nor use /articles/create etc.</p>

<p>The goal is to be to POST a json looking like the entity</p>

<pre><code>{
    &quot;title&quot;: &quot;your title&quot;,
    &quot;body&quot;: &quot;your body&quot;
}
</code></pre>

<p>and if everything is ok to get a <code>201</code> (standard HTTP status code for CREATED) with the created entity</p>

<p>and if not to get a <code>422</code> (standard HTTP status code for `the entity is a json, but the application can&rsquo;t understand it as a valid article)</p>

<p>this time in addition to the <code>postArticlesAction</code> you need also to create a Form class (in `src/AppBundle/Form/ArticleType.php) that will do the conversion and validation for you</p>

<p>check <a href="https://github.com/allan-simon/symfony2-rest-api-example/commit/61c0ca878d82151915705808a5dd20295c8c3b2c">this commit</a> for the list of changes but basically now we have</p>

<ul>
<li>a check that the entity can&rsquo;t contain an empty or null body and title</li>
<li>if valid, the article is saved in database</li>
<li>if valid the article saved, which is <code>id</code> is returned</li>
<li>if non valid a list of why the article is not valid is returned</li>
</ul>

<p>now you can test your POST in the shell by doing</p>

<pre><code> echo '
{
    &quot;body&quot; : &quot;plop2@plop.com&quot;,
    &quot;title&quot; : &quot;hello&quot;
}
' | http POST  http://localhost:8181/app_dev.php/api/articles

</code></pre>

<p>(http is the command provided by <a href="https://github.com/jakubroztocil/httpie">httpie</a> a MUST-HAVE for testing API</p>

<h4 id="toc_10">Important note</h4>

<p>There&rsquo;s actually a much simpler to do, using a technique similar to the one for GET, but
unfortunately it&rsquo;s late at the time of writing, so I will edit this blog post
soon to include it</p>

<h3 id="toc_11">Implement PUT /articles/{id}  (editing an existing article)</h3>

<p><code>PUT</code> is the standard way in HTTP to modify (or create) a resource for which you already
know the URL, in our case to edit, we already know the url, as it is /api/articles/{id}</p>

<p>So it&rsquo;s going to be the same for PUT, which will be a mix between GET and POST</p>

<p>Here it&rsquo;s very simple as we have already created everything in the previous steps,</p>

<p>we let it as an exercise to the reader (or you can directly check on github how it was implemented)</p>

<h3 id="toc_12">Implement DELETE /articles/{id} (delete an existing article)</h3>

<h3 id="toc_13">Conclusion</h3>

<p>Now we know how to create a Full crud which leverage as much as possible the utilities provided
to us by symfony2 and the FOSRestBundle.</p>

<p>We&rsquo;re also now able to fully manage our database over time using the Doctrine migrations tools</p>

<p>In the next part we will see</p>

<ul>
<li>How to add functionnal testing</li>
<li>How to pre-fill the project with fake data</li>
<li>How to create relationship between Resources (Articles and Comments)</li>
</ul>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://allan-simon.github.io/blog/posts/create-a-rest-api-with-symfony2/">
        Create a production ready rest api with symfony2 (part 1)
      </a>
    </h1>

    <span class="post-date">Sat, May 23, 2015</span>

    

<p>What will we cover:</p>

<ul>
<li>how to transform a just-started symfony project into a REST-ready project</li>
<li>how to configure and use the FOSRestBundle to help us in that task</li>
<li>How to use Doctrine migrations to easily transition your database from version N to version N+1</li>
<li>how to add functionnal tests to automatically check your API</li>
<li>how to configure and use the JMSSerializer to automagically serialize and unseralize your data into json (or xml)</li>
<li>How to plug your API to a Oauth2 service</li>
<li>mixed in between some generic advices to make your API reality proof</li>
<li>practical examples of common &ldquo;tricky things&rdquo; (Image uploading / pagination / association between resources etc.)</li>
</ul>

<p>Here we suppose you&rsquo;re already familiar with what a REST API <strong>exactly</strong> means,
and I really mean the emphasis in <strong>exactly</strong></p>

<p>for this I urge you to read these links:</p>

<ul>
<li><a href="http://martinfowler.com/articles/richardsonMaturityModel.html">http://martinfowler.com/articles/richardsonMaturityModel.html</a></li>

<li><p><a href="http://blog.steveklabnik.com/posts/2011-07-03-nobody-understands-rest-or-http">http://blog.steveklabnik.com/posts/2011-07-03-nobody-understands-rest-or-http</a></p></li>

<li><p><a href="https://github.com/interagent/http-api-design">https://github.com/interagent/http-api-design</a></p></li>

<li><p><a href="www.vinaysahni.com/best-practices-for-a-pragmatic-restful-api">www.vinaysahni.com/best-practices-for-a-pragmatic-restful-api</a></p></li>
</ul>

<p>An API is made to resist the test of time, so you can really afford to spend one or
two hours to carefully read these links.</p>

<h3 id="toc_0">Example project</h3>

<p>All the steps described here are applied in this toy project
<a href="https://github.com/allan-simon/symfony2-rest-api-example">https://github.com/allan-simon/symfony2-rest-api-example</a></p>

<p>It&rsquo;s a Blog-like services with a REST API in json at the end it will permit</p>

<ul>
<li>Multiple Authors</li>
<li>Possiblity to add/edit/delete articles</li>
<li>Possibility to comments</li>
<li>Creation of tags to category articles</li>
</ul>

<h3 id="toc_1">Creating the project</h3>

<p>To create the project in a repeatable and automated way,
regardless of your Operating system, we will use this base <a href="https://github.com/we-bridge/vagrant-ansible-symfony">https://github.com/we-bridge/vagrant-ansible-symfony</a>
to bootstrap our project. It simply wrap the symfony2 installer
into a Vagrant machine (i.e a virtual machine), so that all the
additional things such as installing a database, a webserver etc.
are handled for you, in a dedicated environment so that you&rsquo;re
not polluating your own machine.</p>

<p>Make sure you have Vagrant installed and then do</p>

<pre><code>git clone https://github.com/we-bridge/vagrant-ansible-symfony.git
</code></pre>

<p>edit the Vagrantfile as explained in the README, and then</p>

<pre><code>vagrant up
</code></pre>

<p>it takes some times, and at the end you should be able to open
the following address <a href="http://localhost:8080/app/example">http://localhost:8080/app/example</a> in your browser.</p>

<h3 id="toc_2">Adding the FOSRestBundle</h3>

<p>The FOSRestBundle is a bundle providing a lot of classes and method to create easily
a REST api, especially as it&rsquo;s part of the third-party bundles recommanded by Symfony
so in order not to reinvent the wheel we&rsquo;re going to use it.</p>

<p>The full document on how to install it and using it can be found here <a href="http://symfony.com/doc/master/bundles/FOSRestBundle/index.html">http://symfony.com/doc/master/bundles/FOSRestBundle/index.html</a>
Here We&rsquo;re going only to talk about the step necessary to get things running</p>

<p>In the VM , in the symfony2 application directory run</p>

<pre><code>composer require friendsofsymfony/rest-bundle
</code></pre>

<p>Then commit the <code>composer.json</code> and <code>composer.lock</code></p>

<p>Then edit your <code>AppKernel.php</code> and add the bundle</p>

<pre><code>...
new FOS\RestBundle\FOSRestBundle(),
...
</code></pre>

<p>and add in your <code>app/config/config.yml</code></p>

<pre><code># app/config/config.yml
framework:
    # ...
    serializer:
        enabled: true
</code></pre>

<h3 id="toc_3">Creating our first API call GET /api/articles/{id}</h3>

<h4 id="toc_4">Putting all the API calls in /api</h4>

<p>Create the file <code>src/AppBundle/Resources/config/api-routing.yml</code>
(empty for the moment)</p>

<p>Then in your <code>app/config/routing.yml</code></p>

<pre><code>mvms_api:
    type:     rest
    prefix:   /api
    resource: &quot;@AppBundle/Resources/config/api-routing.yml&quot;
</code></pre>

<h4 id="toc_5">Create the controller for all the /api/articles calls</h4>

<h4 id="toc_6">Put the framework to automatically seralize as JSON the returned value of Controller</h4>

<p>Without any change, you still need to create a <code>Response</code> object etc. you can make it even
simpler and directly the object or array to serialize by adding this to your <code>app/config/config.yml</code></p>

<pre><code>fos_rest:
    view:
        view_response_listener: 'force'
        formats:
            json: true
    format_listener:
        rules:
            - { path: ^/api, priorities: [ json ], fallback_format: json, prefer_extension: true }
</code></pre>

<p>We don&rsquo;t cover it here, but actually it&rsquo;s possible, without modifying your code, in one action
to generate a JSON output, a XML output, a HTML output, a RSS output depending on the extension set
or in HTTP header &ldquo;Accept&rdquo; header set.</p>

<p>so now you can add your controller in <code>src/AppBundle/Controller/ArticlesController.php</code></p>

<p>with this content:</p>

<pre><code>&lt;?php

namespace AppBundle\Controller;

class ArticlesController
{

    /**
     * Note: here the name is important
     * get =&gt; the action is restricted to GET HTTP method
     * Article =&gt; (without s) generate /articles/SOMETHING
     * Action =&gt; standard things for symfony for a controller method which
     *           generate an output
     *
     * it generates so the route GET .../articles/{id}
     */
    public function getArticleAction($id)
    {
        return array('hello' =&gt; 'world');
    }

}
</code></pre>

<p>and then in <code>AppBundle/Resources/config/api-routing.yml</code></p>

<pre><code>blog_api_articles:
    type: rest
    resource: &quot;@AppBundle/Controller/ArticlesController.php&quot;
    name_prefix:  api_articles_
</code></pre>

<p>the fact that we&rsquo;ve declared in the routing that this controller is of type rest
will make Symfony2 to automatically create the route</p>

<p><code>/api/articles/{id}</code> restricted to the <code>GET</code> method</p>

<p>for more information on this consult <a href="http://symfony.com/doc/master/bundles/FOSRestBundle/5-automatic-route-generation_single-restful-controller.html#define-resource-actions">http://symfony.com/doc/master/bundles/FOSRestBundle/5-automatic-route-generation_single-restful-controller.html#define-resource-actions</a></p>

<p>so now if you try to access the URL  <code>/api/articles/1</code> with a <code>GET</code>  you will get a</p>

<pre><code>{&quot;hello&quot;:&quot;world&quot;}
</code></pre>

<p>Note that if you return an object, it will actually serialize it also automatically, it&rsquo;s not
only because we&rsquo;re returning an array.</p>

<h3 id="toc_7">Conclusion and next part</h3>

<p>as you can see in some simple step we now have a bundle that in two lines can implement an API
call.</p>

<p>In the next part we will see:</p>

<ul>
<li>How to create an entity and generate a migration file to update the database schema</li>
<li>How to generate a full CRUD API to manipulate this API</li>
<li>How to create functionnal test</li>
</ul>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://allan-simon.github.io/blog/posts/things-i-ve-learn-this-week/">
        Things I&#39;ve learn this week
      </a>
    </h1>

    <span class="post-date">Tue, May 12, 2015</span>

    

<h3 id="toc_0">How to send the unchanged Host header to proxied server with Nginx</h3>

<p>Imagine you have a first nginx acting as a load balancer with this configuration</p>

<pre><code>upstream blue  {
    ...
}

upstream green  {
    ...
}

server {
    include /etc/nginx/backend.conf;

    location / {
        proxy_pass  http://blue;
        proxy_connect_timeout   5;
    }
}


</code></pre>

<p>if you do like that, with <code>blue</code> and <code>green</code> hosting your app, your application
code will see &ldquo;blue&rdquo; or &ldquo;green&rdquo; as the http Host header, which may cause problem
when creating absolue URL</p>

<p>you can override this, and force nginx to send the Host given by the client to
the proxied server unchanged by adding one line like this:</p>

<pre><code>    location / {
        proxy_pass  http://$activeBackend;
        proxy_set_header Host   $http_host; # &lt;= this line
        proxy_connect_timeout   5;
    }


</code></pre>

<h3 id="toc_1">How to reload PHP-fpm without restarting it</h3>

<p>In production you may want to reload php-fpm without restarting it
in order to avoid downtime.</p>

<p>You can do this by sending the unix signal <code>SIGUSR2</code> to the PID of php-fpm</p>

<p>It may provde useful when</p>

<ul>
<li>updating the php.ini</li>
<li>if you to clear the opcache</li>
</ul>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://allan-simon.github.io/blog/posts/vagrant-with-ansible-provisionning-docker-containers-for-symfony2/">
        vagrant with ansible provisionning docker containers for symfony2
      </a>
    </h1>

    <span class="post-date">Sun, Apr 12, 2015</span>

    

<p>In this article we&rsquo;re going to cover:</p>

<ul>
<li>How to use ansible+docker+vagrant to create a one size for all environment for Symfony2 + Nginx + Postgresql + PHP-fpm</li>
<li>How to transition an existing application to fit in that new environment</li>
</ul>

<p>This article take the assumption that you have already heard about all the technologies above without being too familiar with them.</p>

<p>As an example will take the existing Oauth2 server I have created: <a href="https://github.com/allan-simon/oauth2-symfony2-vagrant-fosuserbundle">Oauth2Symfony2</a></p>

<h3 id="toc_0">Introduction</h3>

<p>Recently I&rsquo;ve been reading a lot about Docker, Vagrant and Ansible.
At my company we&rsquo;re already using vagrant and ansible to create our
development machines, and as now the continous testing tool is
using a docker container to run the test, the next step was logically to start
using docker everywhere, in order to have the same environment from the
developers machine to production.</p>

<p>My requirements were the following:</p>

<ul>
<li>Get a model to split our each of our web projects into a set of
docker containers, to increase reusability and reproductability</li>
<li>Use ansible for provisionning, for its powerful feature while yet
staying simple.</li>
<li>Be able to have one command, the same, to create my dev environment on my linux
laptop and to create staging / production etc.</li>
<li>Still be able to have a Vagrant for the developers on Mac/Windows but just
as a layer to provide them the linux necessary to have Docker (and ansible)</li>
<li>In case of Heisenbug, be able to nuke my environment and recreate quickly
in a way I&rsquo;m sure to have something clean, while being sure not to have broken
my computer</li>
<li>To works fine with Symfony2 web applications</li>
</ul>

<h2 id="toc_1">Step 1, getting the Docker containers ready</h2>

<p>For this first try, we&rsquo;re not going to push the logic to its maximun
and we will keep things simple we&rsquo;re going to have 2 Docker containers</p>

<ul>
<li>Postgresql container hosting the database</li>
<li>Nginx+PHP-fpm container hosting the application code</li>
</ul>

<p>We will put all our dockerfiles in a directory <code>DockerFiles</code> with
one subdirectory by container.</p>

<h3 id="toc_2">Postgresql container</h3>

<p>The docker repository has already a very nice <a href="https://registry.hub.docker.com/_/postgres/">official postgresql container</a>
it contains instructions on how to extend it, perfect</p>

<p>So in <code>DockerFiles/postgres</code> we now have</p>

<pre><code># vim:set ft=dockerfile:
FROM library/postgres
</code></pre>

<p>Here nothing funky, we&rsquo;re just saying our container&rsquo;s image will use
the official postgres image as a base. As we progress it will be completed with a script to create a database and a database user, but outside of this it currently perfectly fits our needs</p>

<h3 id="toc_3">Nginx + PHP-fpm</h3>

<p>The docker repository is full of container for PHP-fpm with Nginx but I didn&rsquo;t find any which met my needs:</p>

<ul>
<li>Getting a recent version of PHP (5.5)</li>
<li>PHP with enough PHP-modules pre-instaled (php5-redis and php-posgresql)</li>
<li>Small image size (we&rsquo;re located in China and 300mo instead of 500mo can means an hour or two saved)</li>
</ul>

<p>So I started from a the stock Debian Wheezy image, Debian and not ubuntu because that&rsquo;s on what the Postgres image is based, and it will not necessitate to redownload an other full distribution.</p>

<p>Here&rsquo;s the base docker file we&rsquo;re creating in <code>DockerFiles/Symfony2/</code>, comments have been added inside</p>

<pre><code># vim:set ft=dockerfile:
FROM debian:wheezy

# so that my colleagues know who to yell at
# when they will find a problem in it.
MAINTAINER SIMON Allan &lt;simona@gobeta.com.cn&gt;

# RUN is going to create a new layer, in order to avoid creating
#     dozen of layers, we chain the command with &amp;&amp;
#
# we're adding packages.dotdeb.org repository to get PHP5.5
# and activating the backport to get php5-redis
#
# once done we install the necessary package
# curl to later get composer)
# git to clone non-stable composer packages
# a huge list of php5 modules to cover future usage
#
# at the end we clean all temporary files so that when docker
# create the layer, it is as slim as possible
RUN apt-key adv --keyserver keyserver.ubuntu.com --recv-keys E9C74FEEA2098A6E &amp;&amp; \
    echo &quot;deb http://packages.dotdeb.org/ wheezy-php55 all&quot; &gt; /etc/apt/sources.list.d/php.list &amp;&amp; \
    echo &quot;deb http://ftp.debian.org/debian wheezy-backports main contrib non-free&quot; &gt;&gt; /etc/apt/sources.list.d/php.list &amp;&amp; \
    apt-get update &amp;&amp; \
    apt-get install -y \
        curl \
        git \
        nginx \
        php5-fpm \
        php5-cli \
        php5-xdebug \
        php5-imagick \
        php5-gd \
        php5-mongo \
        php5-curl \
        php5-mcrypt \
        php5-intl \
        php5-mysql \
        php5-sqlite \
        php5-redis \
        php5-pgsql \
    &amp;&amp; rm -rf /var/lib/apt/lists/*

# we directly put composer in the image, so that
# even in case of China blocking the composer website, the image
# will still be usable, as this command may fails (thanks great firewall)
# we put it on a separate RUN, so that we don't need to run the previous
# commands again and again in case of failure.
RUN curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer

# our docker image will put this port as 'public', and then people
# using this image will be able to map it to port on their host machine
EXPOSE 80
EXPOSE 443

# a good practice in docker, as the container themselves can be run
# as demon, is to run the service inside it directly, so that the
# ouput of the service goes on STDOUT and can be gathered using
# standard tool (more on that in an other article)
RUN echo &quot;\ndaemon off;&quot; &gt;&gt; /etc/nginx/nginx.conf

</code></pre>

<h3 id="toc_4">Building the Docker images using Ansible</h3>

<p>For those who don&rsquo;t know <a href="http://docs.ansible.com/">Ansible</a>, it&rsquo;s a tool made to automate all the steps you do in order to setup an environment, be it creating files, installing packages, modifying configuration, making sure a service is started and an other stopped. It works also if the environment is made of several machines scattered over the world, as long as you can SSH to them.</p>

<p>Here the first goal is to make Ansible build these docker images. Latter we will improve it to start containers based on these images and linking them together.</p>

<p>Ansible is used by creating what they call a &ldquo;playbook&rdquo;, a playbook is one or several Yaml files describing the tasks to accomplish or the state to reach. Common tasks like installing packages have pre-made modules to make their description short and easy-to-read.</p>

<p>Before anything make sure you have the latest version of ansible <code>pip install ansible --upgrade</code>, we assume from now that you have the versio <code>1.9.0.1</code>. Then at the root of your working directory create a file name <code>playbook.yml</code> and put that in it</p>

<pre><code>---
- hosts: all
  sudo: yes
  tasks:
    - name: Install Docker-py
      pip: name=docker-py state=present

    - name: check or build image for postgres
      docker_image: path=&quot;./DockerFiles/postgres&quot; name=&quot;allansimon/postgres-for-symfony&quot; state=build

    - name: check or build image for symfony2
      docker_image: path=&quot;./DockerFiles/Symfony2&quot; name=&quot;allansimon/symfony2&quot; state=build


</code></pre>

<p>Here we have a very basic playbook that can be applied to every hosts and that will run every tasks using sudo. Then we describe one task (<code>name</code> is up to you) that will use <code>pip</code> to install <code>docker-py</code> if not already present. Docker-py will be needed for ansible to communicate with Docker.</p>

<p>Then we have two tasks that will build the Dockerfile in <code>path</code> and will associate it ot a name.</p>

<p><strong>Note:</strong> the <code>docker_image</code> is marked as deprecated in the Ansible, however the new <code>docker</code> module has nothing to build Dockerfiles&hellip;</p>

<p><strong>Note 2:</strong> on ubuntu 14.10 I got a bug with the <code>pip</code> installed by apt and I needed to add these tasks at the beginning</p>

<pre><code>  tasks:
    - name: remove pip if installed from apt (fix bug of pip in ubuntu 14.XX)
      apt: name=python-pip state=absent

    - name: Easy install (fix bug of pip in ubuntu 14.XX)
      easy_install: name=pip
    # then the other tasks

</code></pre>

<h3 id="toc_5">Modifying our Postgres image to create a database for Symfony</h3>

<p>Our postgres image is currently very basic, there&rsquo;s postgresql installed inside but no database or user created for our application. Let&rsquo;s fix that.According to the <a href="https://registry.hub.docker.com/_/postgres/">documentation</a> you can add your custom script or SQL query to be launched at the container start by adding your script to the <code>/docker-entrypoint-initdb.d</code> directory. Let&rsquo;s do that, create a file <code>DockerFiles/postgres/make_db.sh</code></p>

<p>with this content</p>

<pre><code>#!/bin/bash
echo &quot;******CREATING DOCKER DATABASE******&quot;
gosu postgres postgres --single &lt;&lt;- EOSQL
    CREATE USER &quot;$APP_DB_USER_NAME&quot; WITH PASSWORD '$APP_DB_USER_PASSWORD';
    CREATE DATABASE &quot;$APP_DB_NAME&quot; WITH OWNER=&quot;$APP_DB_USER_NAME&quot; ENCODING='UTF-8';
EOSQL
echo &quot;******DOCKER DATABASE CREATED******&quot;

</code></pre>

<p>We&rsquo;re going to see just after where the variables come from.</p>

<p>and now lets tell docker to add this script inside the image and to make it executable</p>

<pre><code># vim:set ft=dockerfile:
FROM library/postgres

MAINTAINER SIMON Allan &lt;simona@gobeta.com.cn&gt;

ADD make_db.sh /docker-entrypoint-initdb.d/
RUN chmod +x /docker-entrypoint-initdb.d/make_db.sh 
</code></pre>

<p>Et voila! nothing more for the Dockerfile of postgres.</p>

<p><strong>/!\ One important remark, the file is added once, it means that if you latter modify the file, you need to rebuild the image. For that the &lsquo;easy&rsquo; way I found is to add a blank line in the dockerfile to force it to rebuild, but I guess there&rsquo;s a better way.</strong></p>

<h3 id="toc_6">Start a Postgresql container based on our image from Ansible.</h3>

<p>Now that our image is ready, it&rsquo;s time to start it, add at the end of your <code>playbook.yml</code></p>

<pre><code>
    # we define a new task
    - name: postgresql container
      # this task use the module docker to manage docker from ansible
      docker:
        # it's going to start a container based on our image
        image: allansimon/postgres-for-symfony
        # this specific container will be named app_database
        name: app_database
        # if the container does not exist it will be started, if already
        # started it will be restarted (it was useful while creating
        # the image
        state: restarted
        # we map our local /tmp/postgres to /var/lib/postgresql/data
        # in the container, this way the database is persisted
        volumes:
            - /tmp/postgres:/var/lib/postgresql/data
        # this precise the environment variable that will be given
        # to the container with their value
        env:
            # this one is needed by the base postgres container
            # to define a password to postgres user
            # the explanation about {{ }} notation is coming
            POSTGRES_PASSWORD: &quot;{{ DB_PASSWORD }}&quot;
            # here we have the variables used by our make_db.sh script
            APP_DB_USER_NAME: &quot;{{ APP_DB_USER_NAME }}&quot;
            APP_DB_USER_PASSWORD: &quot;{{ APP_DB_USER_PASSWORD }}&quot;
            APP_DB_NAME: &quot;{{ APP_DB_NAME }}&quot;


</code></pre>

<p>The <code>{{ }}</code> notation is for Ansible variables, there&rsquo;s several ways to declare, we&rsquo;re going to see two, that can be used at the same time, either by putting them directly in your <code>playbook.yml</code> or in a dedicated file. The advatange of the second is that this way you can add this file to your gitignore.</p>

<pre><code>  vars:
    DB_PASSWORD: postgres
  vars_files:
    - external_vars.yml
</code></pre>

<p>and in <code>external_var.yml</code></p>

<pre><code>#for symfony
APP_DB_USER_NAME: symfony_db_user
APP_DB_USER_PASSWORD: symfony_db_password
APP_DB_NAME: symfony_db
</code></pre>

<h3 id="toc_7">Start a Nginx+PHP-fpm container linked to the Postgresql one</h3>

<p>Now that we have our postgres container started it&rsquo;s time to do the same with our container for Nginx and PHP-fpm it takes the same structure as the task for postgres, with just some little thing in more (explained in comments)</p>

<pre><code>    - name: nginx and php-fpm
      docker:
        name: app_webserver
        image: allansimon/symfony2
        state: restarted
        # here we say that the container 'app_database' will be linked
        # to this container, with the local name app_database, i.e all
        # the env variables of app_database will be accessible from app_webserver
        # prefixed with `APP_DATABASE_ENV_` as well as the port exposed by
        # the container (so only the webserver will have access to the db)
        links:
            - &quot;app_database:app_database&quot;
        # Here as we need the webserver to be accessible from the outside
        # we map our laptop port 8088 to the port 80 of the container
        ports:
            - &quot;8088:80&quot;
        # it is possible to map as many directory as you need
        # the only restriction is that it must be an asbolute path
        # hence why we use a variable APP_DIR
        volumes:
            - &quot;{{ APP_DIR }}:/var/www&quot;
            - /tmp/nginx-logs:/var/logs/nginx
        env:
            # more on these variables sooon
            GITHUB_TOKEN : &quot;{{ GITHUB_TOKEN  }}&quot;
            APP_DB_USER_NAME: &quot;{{ APP_DB_USER_NAME }}&quot;
            APP_DB_USER_PASSWORD: &quot;{{ APP_DB_USER_PASSWORD }}&quot;
            APP_DB_NAME: &quot;{{ APP_DB_NAME }}&quot;
            APP_MAILER_HOST: &quot;{{ APP_MAILER_HOST }}&quot;
            APP_MAILER_USER: &quot;{{ APP_MAILER_USER }}&quot;
            APP_MAILER_PASSWORD: &quot;{{ APP_MAILER_PASSWORD }}&quot;
</code></pre>

<p>With that, our Symfony app will have all the information it needs to access to the database, and to be accessed from the outside</p>

<h3 id="toc_8">Finalize the configuration of the Nginx+PHP-fpm image</h3>

<p>Our two containers are now able to communicate but the same as we needed to create a database to make our postgres container useful, we&rsquo;re going to need to tweak a little our Nginx+PHP-fpm container in order to</p>

<ul>
<li>have a virtualhost that sends file to PHP-fpm</li>
<li>get a timezone precised in our php.ini (otherwise symfony2 will refuse
to work)</li>
<li>have our container that run composer install when started</li>
<li>get nginx service started as well as php-fpm</li>
</ul>

<p>so we&rsquo;re going to add this at the end of our <code>DockerFiles/Symfony2/Dockerfile</code></p>

<pre><code># we put our self-defined vhost (see below for the content)
COPY config/vhost.conf /etc/nginx/sites-enabled/default

# we put our additional php configuration and we enable it
COPY config/php-extra.ini /etc/php5/mods-available/extra.ini
RUN php5enmod extra

# we copy our script and we make sure it is executable
COPY entrypoint.sh /root/entrypoint.sh
RUN chown root:root /root/entrypoint.sh 
RUN chmod +x /root/entrypoint.sh

# more on that in a latter article
VOLUME [&quot;/var/www&quot;, &quot;/var/log/nginx/&quot;]

# when our container is started this script will be run
# (it was not in our postgres dockerfile because the base image already
# had it.
ENTRYPOINT [&quot;/root/entrypoint.sh&quot;]

</code></pre>

<p>now the configuration file themselves</p>

<h4 id="toc_9">DockerFiles/Symfony2/config/vhost.conf</h4>

<p>This vhost is specifically for symfony2 applications
you maybe to adapt it if you plan to run other kind
of php websites.</p>

<pre><code>
server {
    listen 80 default_server;
    listen [::]:80 default_server ipv6only=on;

    server_name localhost;

    root /var/www/web;
    index index.html index.htm index.php;

    location / {
        try_files $uri /app.php$is_args$args;
    }

    error_page 500 502 503 504 /50x.html;
    location = /50x.html {
        root /usr/share/nginx/www;
    }

    location ~ ^/(app|app_dev|config)\.php(/|$) {
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        fastcgi_pass unix:/var/run/php5-fpm.sock;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param HTTPS off;
    }
}

</code></pre>

<h4 id="toc_10">DockerFiles/Symfony2/config/php-extra.ini</h4>

<p>nothing fancy in it</p>

<pre><code>date.timezone = UTC
</code></pre>

<h4 id="toc_11">DockerFiles/Symfony2/entrypoint.sh</h4>

<pre><code>#!/bin/bash

# for development machines
if [ $DEBUG ]; then
    echo &quot;xdebug.remote_connect_back=On&quot; &gt;&gt; /etc/php5/fpm/conf.d/20-xdebug.ini
    echo &quot;xdebug.remote_enable=On&quot; &gt;&gt; /etc/php5/fpm/conf.d/20-xdebug.ini
fi

cd /var/www

# if no specific command are precised when the container is started:
if [ -z &quot;$1&quot; ];
    then

    # if you're in china and that for some reason
    # the docker build has failed to download composer.phar...
    if ! which composer; then
        curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
    fi
    # variable provided by ansible when launching the docker container
    mkdir ~/.composer
    cat &gt; ~/.composer/config.json &lt;&lt;EOS
{
    &quot;config&quot;: {
        &quot;github-oauth&quot;: { &quot;github.com&quot;: &quot;$GITHUB_TOKEN&quot; }
    }
}
EOS
    # we make sure to start fresh
    rm app/config/parameters.yml
    composer install
    rm -rf app/cache/*
    php app/console assets:install --symlink web/
    php app/console c:c
    php app/console c:w
    # not pretty ...
    chmod -R 777 app/logs
    chmod -R 777 app/cache

    service php5-fpm restart
    nginx
else
    exec &quot;$@&quot;
fi
</code></pre>

<p>Several things:</p>

<ul>
<li>We create a config.json for composer to put inside our github token to avoid composer install to hang because we&rsquo;re reached github anonymous limit.</li>
<li>We delete the parameters.yml so that we&rsquo;re sure it&rsquo;s recreated everytime, which is important in case we change the environment variables or the parameters.yml.dist</li>
<li>we clear and warmup the cache</li>
<li>it&rsquo;s a bit hackish , but we make sure the logs and cache directory are writeable by symfony. (I did like this because it seems the application is run with a user that only have a UID but no username, and searching on the internet, different people seems to have different UID)</li>
<li>then we start the php5-fpm service (in a perfect docker world, it should be on dedicated container so that we can easily its output)</li>
<li>we start nginx as a process in the foreground</li>
</ul>

<p>To get your github token, you can take a look at my previous article on <a href="http://allan-simon.github.io/blog/posts/solve-composer-github-api-limitation/">how to generate one to use with composer.</a></p>

<p>Now our environment is fully ready we&rsquo;re only left with adapting our appliction</p>

<h3 id="toc_12">Adapting our symfony application to fit in</h3>

<p>Here&rsquo;s there&rsquo;s nothing much to change itself in the code, we simply need to tell Symfony2 to look in priority for the environment variables. The problem is Symfony2 itself looks for variable starting with <code>SYMFONY__</code> and the second problem is that the <code>parameters.yml</code> has priority over the environment variables&hellip;</p>

<p>To solve that there&rsquo;s a simple trick, (first make sure your parameters.yml is not versionned), composer.json has a package that can be used to generate your parameters.yml and it can be used to generate it based on environment variables</p>

<p>Make sure you have in your composer.json</p>

<pre><code>&quot;require&quot;: {
    ...

    &quot;incenteev/composer-parameter-handler&quot;: &quot;~2.0&quot;,
    ...
}
...
&quot;scripts&quot;: {
    ...
    &quot;post-install-cmd&quot;: [
        &quot;Incenteev\\ParameterHandler\\ScriptHandler::buildParameters&quot;,
        ...
    ],
    &quot;post-update-cmd&quot;: [
        &quot;Incenteev\\ParameterHandler\\ScriptHandler::buildParameters&quot;,
        ...
    ]
},

</code></pre>

<p>Then in the <code>extra</code> section you can add <code>env-map</code> section to say to which environment variables to use (if present) to generate which parameter of your <code>parameters.yml</code></p>

<p>In our case</p>

<pre><code>    &quot;extra&quot;: {
        ...
        &quot;incenteev-parameters&quot;: {
            &quot;env-map&quot; : {
                &quot;database_host&quot;: &quot;APP_DATABASE_PORT_5432_TCP_ADDR&quot;,
                &quot;database_port&quot;: &quot;APP_DATABASE_PORT_5432_TCP_PORT&quot;,

                &quot;database_name&quot;: &quot;APP_DB_NAME&quot;,
                &quot;database_user&quot;: &quot;APP_DB_USER_NAME&quot;,
                &quot;database_password&quot;: &quot;APP_DB_USER_PASSWORD&quot;,

                &quot;mailer_host&quot;: &quot;APP_MAILER_HOST&quot;,
                &quot;mailer_user&quot;: &quot;APP_MAILER_USER&quot;,
                &quot;mailer_password&quot;: &quot;APP_MAILER_PASSWORD&quot;
            },
            &quot;file&quot;: &quot;app/config/parameters.yml&quot;
        },
        ...
    }
</code></pre>

<p>The two first environment variables come from the variables given by docker to the <code>app_webserver</code> when linking with <code>app_database</code></p>

<h3 id="toc_13">Running everything</h3>

<p>Now that everything is done you can run your playbook using:</p>

<pre><code>sudo  ansible-playbook playbook.yml --connection=local -i &quot;[default] localhost,&quot; 
</code></pre>

<p>it tells to run the playbook on your local machine.</p>

<h3 id="toc_14">Link it to vagrant</h3>

<p>All of that works fine if you&rsquo;re on a Linux machine, so for your fellow Mac or Windows colleague you can create this <code>Vagrantfile</code></p>

<pre><code>
def host_box_is_unixy?
  (RUBY_PLATFORM !~ /cygwin|mswin|mingw|bccwin|wince|emx/)
end


Vagrant.configure(&quot;2&quot;) do |config|
    config.vm.box = &quot;ubuntu/trusty64&quot;

    config.vm.network &quot;forwarded_port&quot;, guest: 80, host: 8080
    config.vm.network &quot;private_network&quot;, ip: &quot;192.168.50.12&quot;

    if host_box_is_unixy?
        config.vm.synced_folder &quot;./&quot;, &quot;/vagrant&quot;, type: &quot;nfs&quot;
    else
        config.vm.synced_folder &quot;./&quot;, &quot;/vagrant&quot;, type: &quot;smb&quot;, mount_options: ['ip=192.168.50.1'] #host side of :private_network
    end


    config.vm.provision :shell, :inline =&gt; &lt;&lt;-END
        set -e
        if ! which ansible-playbook ; then
            sudo sh -c &quot;wget -qO- https://get.docker.io/gpg | apt-key add -&quot;
            sudo sh -c &quot;
                echo deb http://get.docker.io/ubuntu docker main &gt; \
                /etc/apt/sources.list.d/docker.list
            &quot;
            sudo apt-get update
            sudo apt-get -y install \
                lxc-docker \
                python-software-properties \
                python-pip
            sudo pip install ansible
        fi
        cd /vagrant
        sudo  ansible-playbook playbook.yml --connection=local -i &quot;[default] localhost,&quot; 
    END
end
</code></pre>

<p>it is not treated in this article but for Symfony2 performance reason on Vagrant, you may want to put the cache and logs folder outside of the share folder.</p>

<h3 id="toc_15">Useful commands</h3>

<h3 id="toc_16">Run a command in a given container</h3>

<p>for example you want to run phpunit</p>

<pre><code>sudo docker exec -it app_webserver   /var/www/bin/phpunit -c  /var/www/app
</code></pre>

<p>or if you want to &lsquo;ssh&rsquo; into the machine</p>

<pre><code>sudo docker exec -it app_webserver bash
</code></pre>

<h3 id="toc_17">Get the logs</h3>

<pre><code>sudo docker logs -f app_webserver   
</code></pre>

<h3 id="toc_18">Delete an image</h3>

<p>Let&rsquo;s say it&rsquo;s 3AM you&rsquo;re trying desperately to modify the Dockerfile of the database but nothing change, so you want to nuke everything and start fresh</p>

<p>First stop and remove the container using</p>

<pre><code>sudo docker stop app_database2
sudo docker rm app_database2

</code></pre>

<p>then delete the image itself</p>

<pre><code>sudo docker rmi allansimon/postgres-for-symfony
</code></pre>

<h3 id="toc_19">Further improvements</h3>

<p>With that you should have a good starters to have your application running in dockers , while still providing an easy environment to deploy for your developers, but things can be of course furthered improve (I will try to cover them in other articles)</p>

<ul>
<li>Integrate it smoothly with your continous-testing system (for example gitlab-ci)</li>
<li>Split the containers in smaller ones (for example nginx and php-fpm in separate ones)</li>
<li>Put the data in Docker volumes to easily backup your data</li>
<li>Have a procedure to easily rollout a new release that include database migrations (using the excellent DoctrineMigration) without stopping the service or breaking things</li>
<li>Use kubernetes to manage your running containers to restart them if one crash etc.</li>
<li>Make your application scalable by being able to pop-out more instance of the web application and getting it to work nice with a loadbalancer</li>
<li>Make your database scalable by using tools like <code>pgpool II</code></li>
<li>Be able to have our containers over several physical machines</li>
</ul>

<h3 id="toc_20">Articles that helped me wrote this one and further reading</h3>

<h4 id="toc_21">About the content of this article</h4>

<ul>
<li><a href="http://docs.ansible.com/docker_module.html">Ansible documentation on docker</a></li>
<li><a href="http://docs.ansible.com/docker_image_module.html">Ansible documentation on docker images</a></li>
<li><a href="http://patg.net/ansible,docker/2014/06/20/ansible-docker-image/">How to build docker images with Ansible</a></li>
<li><a href="http://victorlin.me/posts/2014/08/11/building-docker-image-with-ansible">Other article on creating docker images with Ansible</a></li>
<li><a href="http://www.slideshare.net/denderello/dockerizing-symony-applications-symfony-live-berlin-2014">Dockerizing Symfony Application</a></li>
<li><a href="http://www.slideshare.net/nevalla/building-high-availability-application-with-docker">Building HA Application with Docker</a></li>
<li></li>
</ul>

<h4 id="toc_22">Further reading</h4>

<ul>
<li><a href="http://devopscube.com/how-to-link-docker-containers-across-hosts-the-ambassador-pattern/">How to link docker containers accross host</a></li>
<li><a href="http://getprismatic.com/story/1428327711576?share=MzE2MzYy.MTQyODMyNzcxMTU3Ng.6TZneNzk4ocS2YDOFkjk5AM0r-Y">Using Apache Mesos to get a production ready environment</a></li>
<li><a href="http://www.slideshare.net/rajdeep/docker-swarm-introduction?next_slideshow=1">Docker swarm</a></li>
<li><a href="http://www.scoop.it/t/docker-by-docker">List of articles on Docker</a></li>
<li><a href="http://docs.ansible.com/playbooks_delegation.html">Doing rolling update with ansible</a></li>
<li><a href="https://www.digitalocean.com/community/tutorials/how-to-horizontally-scale-a-laravel-4-app-with-a-postgresql-database">How to scale a Laravel application with postgresql</a></li>
<li><a href="http://www.slideshare.net/pgodel/symfony-live-nyc-2014-rock-solid-deployment-of-symfony-apps">Rock solide deployement of Symfony application</a></li>
</ul>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://allan-simon.github.io/blog/posts/doctrine2-order-by-count-many-to-many/">
        doctrine2 order by count many to many
      </a>
    </h1>

    <span class="post-date">Thu, Apr 9, 2015</span>

    

<p>Today I found a problem quite common but tricky enough for the solution
to share it with you</p>

<h3 id="toc_0">The problem</h3>

<p>I have 2 Entities</p>

<ul>
<li>User</li>
<li>Article</li>
</ul>

<p>and a &ldquo;likedByUsers&rdquo; Many To Many relationship between both</p>

<p>Now I would like to get the Articles ordered by number of &lsquo;likes&rsquo;
for an API call returning a list of Articles</p>

<p>if you feel smart you can try to find the solution by yourself
it&rsquo;s an interesting exercise about &lsquo;how much do you know doctrine and SQL&rsquo;</p>

<p>but let me tell you, the solution is like an Egg of Columbus, once you see
it it becomes evident, but it was actually not that simple at first.</p>

<h3 id="toc_1">The solution</h3>

<pre><code>// in your repository
$builder = $this-&gt;createQueryBuilder('a');
    -&gt;select('COUNT(u) AS HIDDEN nbrLikes', 'a')
    -&gt;leftJoin('a.likedByUsers', 'u') 
    -&gt;orderBy('nbrLikes', 'DESC')
    -&gt;groupBy('a')
    -&gt;getQuery()
    -&gt;getResult()
;
</code></pre>

<h3 id="toc_2">Step by step</h3>

<pre><code>-&gt;leftJoin('a.likedByUsers', 'u')
</code></pre>

<p>as it&rsquo;s a many to many relationship, and as doctrine lazy-load by default
we need to explicitly tell him we will need the join, and the referenced
entity (users) will be refered as <code>u</code> in the other part of the query</p>

<p>now the interesting point here is the <code>leftJoin</code>, most PHP developers
are not familiar with the different type of Join</p>

<ul>
<li><code>inner join</code> would have taken only the articles and users who have <strong>At least</strong> one relationship
which mean that using this, you will not get back the articles with 0 likes</li>
<li><code>left join</code> take ALL the row on the left side (so here articles) and the entity on the right will
be null if there&rsquo;s no relationship, so here that&rsquo;s what we want, as then the <code>COUNT()</code> will consider norelationship as <code>0</code></li>
</ul>

<pre><code>    -&gt;groupBy('a')
</code></pre>

<p>here it&rsquo;s really important to group by the FULL entity and not just <code>a.id</code>, otherwise SQL
will complain that your other fields are not inside the GROUP BY (here nothing specific as doctrine,
it&rsquo;s pure SQL, just that Doctrine makes your life easier by permitting you not to precise
every single field one by one</p>

<pre><code>    -&gt;select('COUNT(u) AS HIDDEN nbrLikes', 'a')
</code></pre>

<p>Here we have the actual interesting part
we select a <code>COUNT</code> in order to be able to use it in the <code>ORDER BY</code> and also the
entity article itself, however if we were just doing <code>'COUNT(u) AS nbrLikes' , a</code>
then for each result, we would not directly the entity, but an array of two values
the count and then the entity (which would need additional treatment in my case
as I&rsquo;m just returning an array of Article to be serialized by the REST bundle).</p>

<p>That&rsquo;s why we have <code>HIDDEN</code>, it will tell doctrine to use it for the generated query
but not to use when creating the result array, so that it returns only the entity</p>

<p>For those wondering if I only get the entity how to have my API call returning also
a <code>number_of_likes</code> in the JSON, I will later make an article about virtual property
of the JSM Serializer</p>

<p>Hope you learn something in the process,</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://allan-simon.github.io/blog/posts/gitlab-ci-with-docker-runner/">
        gitlab ci with docker runner
      </a>
    </h1>

    <span class="post-date">Sun, Mar 29, 2015</span>

    

<p>In my company we&rsquo;re using <a href="https://gitlab.com">Gitlab</a> for managing our code
and doing code review. For the last months we&rsquo;ve been standardizing our stack
on Symfony/Postgresql/php-fpm. Recently we&rsquo;ve started automatizing our tests
using phpunit. The next step was of course to have a start of continuous
integration and to be able to run our tests at each Merge request.</p>

<p>In this article we&rsquo;re going to view</p>

<ul>
<li>How to install gitlab-ci on a separate server than your gitlab instance</li>
<li>How to put gitlab-ci behind your company frontal server</li>
<li>How to make gitlab-ci run your tests in a Docker container</li>
</ul>

<h2 id="toc_0">Gitlab-CI in a separate instance</h2>

<p>To do continous-integration you got plenty of choice, the most popular one being
<a href="http://jenkins-ci.org">jenkinks</a>. However it seems to be that it is a bit bloated
and has too much feature that we don&rsquo;t need for the moment.</p>

<p>On the other side gitlab comes with its own CI system (named Gitlab-ci) that has
the advantage to be damn simple for the moment and of course pretty much integrated
to gitlab (no need to create new accounts, build status directly in gitlab etc.)</p>

<p>In order to install it you can use the <a href="https://about.gitlab.com/downloads/">ommibus package</a>
which will take care of installing everything from you</p>

<p>Then in order to have only gitlab-ci you can can follow the step <a href="https://gitlab.com/gitlab-org/omnibus-gitlab/blob/master/doc/gitlab-ci/README.md">Running Gitlab on its own server</a></p>

<h2 id="toc_1">Gitlab-CI behind your company&rsquo;s frontal server</h2>

<p>Our company as one public IP under which we host all our services.
We have then a frontal apache2 (but it could have been a nginx) which proxify
then the request depending of the hostname. In that case it does not make
sense for us to still have the Nginx that is installed with the omnibus package</p>

<p>So in order to deactivate it, in your <code>/etc/gitlab/gitlab.rb</code> in the Nginx section
you can add</p>

<pre><code>nginx['enable'] = false
ci_nginx['enable'] = false
</code></pre>

<p>and then</p>

<pre><code>sudo gitlab-ctl reconfigure 
</code></pre>

<p>then in your frontal you can put a vhost</p>

<pre><code>&lt;VirtualHost  *:80&gt;
    ServerName gitlab-ci.example.com

    ProxyRequests off
    ProxyPreserveHost on
    ProxyPass / http://LAN_IP_OF_YOUR_GITLAB_CI:8181/
    ProxyPassReverse / http://LAN_IP_OF_YOUR_GITLAB_CI:8181/
&lt;/VirtualHost&gt;
</code></pre>

<p>(by default gitlab-ci&rsquo;s unicorn listen on port 8181)</p>

<h2 id="toc_2">Tell Gitlab-ci to run your test into a docker container</h2>

<p>Gitlab-ci use what they call a &ldquo;Runner&rdquo; to run your test, it&rsquo;s more
or less a spare machine in which Gitlab-ci will clone your project
and run a bash script you&rsquo;ve provided in the Gitlab-ci admin panel</p>

<p>The goal of this article is not to do a deep introduction to <a href="https://www.docker.com/">Docker</a>
but basically it&rsquo;s a powerful technology that permits you to run &ldquo;containers&rdquo;.
You can consider a container as a virtual machine without the virtual part, and restricted
to Linux. (more or less)</p>

<p>The container will brings their full advatanges with gitlab-ci as</p>

<ul>
<li>they don&rsquo;t take extra memory when not being runned</li>
<li>you can create a new container from a base image in a blink of eyes</li>
</ul>

<p>Fortunately for us a Docker image already exists with all the base
things to have a Gitlab-ci Runner in a container. <a href="https://github.com/sameersbn/docker-gitlab-ci-runner">The repository</a></p>

<p>If you have already docker installed you can pull the image doing</p>

<pre><code>docker pull sameersbn/gitlab-ci-runner:latest
</code></pre>

<p>Then you need to register your runner to gitlab-ci you can do that with</p>

<pre><code>mkdir -p /opt/your-project-runner
docker run --name your-project-runner -it --rm \
    -v /opt/your-project-runner:/home/gitlab_ci_runner/data \
  sameersbn/gitlab-ci-runner:latest app:setup
</code></pre>

<p>it will ask you some information given to you by your instance of gitlab-ci</p>

<p>you can then pop a runner by doing</p>

<pre><code>docker run --name your-project-runner -it -d \
    -v /opt/your-project-runner:/home/gitlab_ci_runner/data \
  sameersbn/gitlab-ci-runner:latest app:setup
</code></pre>

<p>you will certainly to customize some stuff on your container
you can do so by connecting as root to it using</p>

<pre><code>docker exec -it your-project-runner bash
</code></pre>

<p>of course something to keep in mind is that container are meant to be stateless
which mean that outside of the directories you map with <code>-v</code> option
the other information will be deleted when you restart the container</p>

<p>So if you need to always create the same kind of container, you can create
your own Runner container by extending this one to fit your needs, like
it has been done in the <a href="https://github.com/sameersbn/docker-runner-gitlab">docker image to run test for gitlab&rsquo;s own source code</a></p>

<p>In a next article we will see in details how to create step by step your own
Gitlab-ci for your php/symfony project</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://allan-simon.github.io/blog/posts/symfony-create-your-own-third-party-bundle/">
        symfony create your own third party bundle part 1/4
      </a>
    </h1>

    <span class="post-date">Sat, Mar 28, 2015</span>

    

<p>So you&rsquo;ve reached the point where you&rsquo;re reusing the same service accross
symfony application, again and again and you feel like this could even
be useful for other people. You decide that it will be great if you could
do like adults and have your own bundle.</p>

<p>Here is how to create one from scratch, you can find the repo here <a href="https://travis-ci.org/we-bridge/OAuth2AccessBundle">Oauth2AccessBundle</a></p>

<p>we cover these steps:</p>

<ol>
<li>Creating the base repo in github and composer.json</li>
<li>Adding the base Classes</li>
<li>Permit users of your bundle to configure it</li>
<li>Make your bundle testable</li>
</ol>

<h3 id="toc_0">Create the base repo and composer.json</h3>

<p>Well for creating the base repo, nothing different from any new repo on github.
I would however stressed out that you should chose since the beginning a license</p>

<p>I would recommend either</p>

<ul>
<li>The MIT license, the one I personnaly chose, it permits your bundle to be
used without overthinking even by Companies with lawyer</li>
<li>The AGPL license, no the A is not a typo, like the GPL license it does
oblige people which integrate your bundle into application to make the full
application also in a GPL-compatible license and to redistribute the modified
source code with the application itself. HOWEVER, at the difference of the GPL
it cover also the case of websites/webservices/REST API (for the GPL, it only
works if the company which has made modification sells the website itself
to other customers)</li>
</ul>

<p>You can of course chose the license your want, but be sure of what they implies.
(As said for example the GPL will not force people who use and modify your
bundle in their own website to give you back patches etc.)</p>

<p>Then add a <code>composer.json</code> file with that skeleton content</p>

<pre><code>{
    &quot;name&quot; : &quot;webridge/oauth2-access-bundle&quot;,
    &quot;type&quot; : &quot;symfony-bundle&quot;,
    &quot;description&quot; : &quot;Symfony Oauth2 consumer bundle&quot;,
    &quot;keywords&quot; : [&quot;Symfony&quot;, &quot;Oauth2&quot;],
    &quot;homepage&quot; : &quot;https://github.com/we-bridge/OAuth2AccessBundle&quot;,
    &quot;license&quot; : &quot;MIT&quot;,
    &quot;authors&quot; :
    [
        {
            &quot;name&quot; : &quot;Allan SIMON&quot;,
            &quot;email&quot; : &quot;allan.simon@supinfo.com&quot;,
            &quot;homepage&quot; : &quot;http://allan-simon.github.io/blog&quot;,
            &quot;role&quot; : &quot;Developer&quot;
        }
    ],
    &quot;minimum-stability&quot; : &quot;beta&quot;,
    &quot;require&quot;: {
        &quot;php&quot;: &quot;&gt;=5.3.2&quot;
    },
    &quot;autoload&quot;: {
        &quot;psr-0&quot;: { &quot;Webridge\\Oauth2AccessBundle&quot;: &quot;&quot; }
    },
    &quot;target-dir&quot; : &quot;Webridge/Oauth2AccessBundle&quot;
}
</code></pre>

<p>The <code>name</code> part is totally up to you but it needs to be unique accross
composer packages so most of the time <code>your-name-or-company/your-bundle-name</code>
is safe.</p>

<p>The <code>autload</code> part precise in which namespace your bundle classes will be
accessed</p>

<p>Now that we have the very base of our repository, we will see in next
post how to create a very basic service without configuration.</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://allan-simon.github.io/blog/posts/migrate-down-with-doctrine-migrations/">
        migrate down with doctrine migrations
      </a>
    </h1>

    <span class="post-date">Sat, Mar 14, 2015</span>

    <p>if you&rsquo;re using Doctrine in your Symfony2 project, you&rsquo;re certainly using the
excellent <a href="http://symfony.com/doc/current/bundles/DoctrineMigrationsBundle/index.html">Doctrine Migration Bundle</a>
but you may have seen that documentation is not staging clearly how to migrate down</p>

<p>for that:</p>

<pre><code>php app/console doctrine:migrations:status

</code></pre>

<p>take the number in &ldquo;Current Version&rdquo; (format YYYYMMDDHHMMSS)</p>

<p>and then run</p>

<pre><code>php app/console doctrine:migrations:execute YYYYMMDDHHMMSS --down
</code></pre>

<p>that&rsquo;s all folks !</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://allan-simon.github.io/blog/posts/symfony-2.6-tips-1/">
        symfony 2.6 tips #1
      </a>
    </h1>

    <span class="post-date">Wed, Mar 11, 2015</span>

    

<p>Here a list of tips for symfony 2.6 I&rsquo;ve gathered these days</p>

<p>###Skip test in phpunit</p>

<p>Imagine you&rsquo;re rewriting your application to split &lsquo;big&rsquo; pages into
set of smaller actions. You got your test already written but they
are going to fail the time you finish the rewrite, and because you&rsquo;re
in company with tight deadline, you don&rsquo;t have time to adapt the tests
&ldquo;right here right now&rdquo; several possibilities</p>

<ul>
<li>Leave the tests failing until you fix them <code>master</code>.</li>
<li>Delete the test.</li>
<li>Put between comments the failing tests.</li>
</ul>

<p>All these solutions are suboptimals, instead you can add this line at the beginning of your test method</p>

<pre><code>public function testMyTestWhichYouWantToSkip()
{
    $this-&gt;markTestSkipped(&quot;message explaining why it's skipped&quot;);
    // your test code, unmodified
}
</code></pre>

<p>so that it will appear with a <code>S</code> in the test report, so that you have a reminder that there&rsquo;s something to fix.</p>

<h3 id="toc_0">Disable form validation in test</h3>

<p>You&rsquo;re writing functionnal test and you need to check the case of an form submitted with bogus data (to be sure your server side code is protected against hand-crafted request). By default the form you get in functionnal test will have the same checking rules than the one on server side, so in order to disable checking you can do</p>

<pre><code>$form['country']-&gt;disableValidation()-&gt;select('Invalid value');
</code></pre>

<h3 id="toc_1">(Doctrine) don&rsquo;t use findById() when you just mean find()</h3>

<p>well, the title is self-explaining</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://allan-simon.github.io/blog/posts/redmine-cli/">
        Redmine-cli and redmine API
      </a>
    </h1>

    <span class="post-date">Wed, Feb 25, 2015</span>

    

<p>I found a tool to manage redmine from the cli, in python:</p>

<p><code>pip install redmine-cli</code></p>

<p>then a config file <code>~/.redmine-cli</code></p>

<pre><code>[default]
key=API_KEY_YOU_CAN_SEE_IN_YOUR_ACCOUNT_ON_REDMINE
my_id=ID_YOU_CAN_ON_YOUR_PROFILE_PAGE
root_url=HOME_PAGE_OF_REDMINE
</code></pre>

<p>then you can do</p>

<ol>
<li><code>redmine open 123</code> to open the issue 123 in your browser</li>
<li><code>redmine issues</code> to see your issues</li>
<li><code>redmine issue 123</code> to see information about issue 123</li>
</ol>

<p>(it has more options I let you check the doc)</p>

<ul>
<li><a href="https://github.com/yanjost/redmine-cli">original repo</a></li>
<li><a href="https://github.com/allan-simon/redmine-cli">my fork where I have some features (like updating a ticket</a></li>
</ul>

<p>(hopefully my modification are in PR on the original repo and will be soon integrated)
my modification include so far:</p>

<ul>
<li><code>redmine issue 123 long</code> to see more detailled information about the issue</li>
<li><code>redmine update 123 'in progress'</code> to update the status to <code>in progress</code> (admitting your redmine has this status)</li>
</ul>

<h3 id="toc_0">The long story behind:</h3>

<p>As any good Linux user, I love the CLI (no, there&rsquo;s no such thing
as a <strong>good</strong> Linux user who does not love the CLI). Starting from
that, though I appreciate using Redmine to manage features to implement,
bugs etc. I&rsquo;m not really fan of needing to click here and there,
especially when the only things I want is</p>

<ul>
<li>know what a Merge request on gitlab referencing the ticket XXX is about</li>
<li>see what tickets are assigned to me</li>
<li>update a ticket status</li>
</ul>

<p>It becomes even less practical when you want to update a list of ticket
you can either:</p>

<ol>
<li>select in the list, while keeping shift pressed, the list of ticket you want to update</li>
<li>right click,</li>
<li>update the status</li>
</ol>

<p>The problem of that technique is that, if you click a little too much on the right,
on the left etc. you loose your selection, which can be very frustating
Then you have the second technique</p>

<ol>
<li>click on ticket N</li>
<li>click on update</li>
<li>update, click on submit</li>
</ol>

<p>each of these steps impliying a page load, no need to tell you how much times
it takes even for 5 tickets</p>

<h3 id="toc_1">The CLI will always be there for you: redmine-cli</h3>

<p>For now some month, whenever I&rsquo;m looking for that little tool, the reflex is to
search for it on github. As I knew there was a Redmine API and that we don&rsquo;t have
time for a NIH (Not Invented Here) syndrom, it was very likely such a CLI tool
would already exist.</p>

<p>I found a several tool, <a href="https://github.com/diasjorge/redmine-cli">one in ruby</a>
which seems rather complete, but as it was not updated for 2 years, and I didn&rsquo;t felt
like installing ruby on my computer (I guess it&rsquo;s already install but&hellip;) and it was
late, so losing 2 minutes to know how to install the project was too much</p>

<ul>
<li>ALWAYS PUT CLEAR INSTRUCTION , DUMB PROOF, ON HOW TO INSTALL YOUR TOOL</li>
<li>if a project is &ldquo;complete&rdquo; and its the reason why you&rsquo;re not updating it, state it
so that people know if the project is dead or just &lsquo;in good shape enough but the author is still active&rsquo;</li>
</ul>

<p>So I found the python project, which was updated in 2014 and
had clear installation instruction <code>pip install redmine-cli</code></p>

<h3 id="toc_2">Missing feature: redmine API my love</h3>

<p>while implementing the feature I found that</p>

<ul>
<li>the API call was returning a 200 (without nothing in the body)</li>
<li>BUT the status was not updated (though the ticket was showing activity &lsquo;less than a minute ago&rsquo;)</li>
</ul>

<p>after some research I found <a href="http://www.redmine.org/boards/2/topics/25920">that redmine discussion</a></p>

<ul>
<li>I need to declare the header <code>Application/Json</code> (normal)</li>
<li>It needs to have the <code>status_id</code> value as a string (and I was giving an integer)</li>
</ul>

<p>The second point is raging because GUESS WHAT, that integer was given to me BY REDMINE ITSELF !
So please please when you do an API</p>

<ul>
<li>Be consistent, if <code>status_id</code> is an integer once, it must always be a integer</li>
<li>Have a clear documentation, with example</li>
</ul>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://allan-simon.github.io/blog/posts/form-name-goes-into-global-scope-javascript/">
        Form name goes into global scope in javascript
      </a>
    </h1>

    <span class="post-date">Mon, Feb 23, 2015</span>

    

<p>An interesting problem a friend of mine discovered today</p>

<p>Can you spot the problem?</p>

<h3 id="toc_0">Le javascript</h3>

<pre><code>var CreateVersion = (function(){
    'use strict';

    var foo = function(text) {
        console.log(text);
    };

    return {
        foo : foo 
    };
}());
</code></pre>

<h3 id="toc_1">Le HTML</h3>

<pre><code>&lt;form name=&quot;CreateVersion&quot; method=&quot;post&quot; action=&quot;&quot;&gt;
    &lt;div class=&quot;form-group&quot;&gt;
        &lt;label&gt;
            &lt;span&gt;something&lt;/span&gt;
            &lt;!--
                onClick on a span is a bad pratice and will be
                the object of an other post
            --&gt;
            &lt;span onclick=&quot;CreateVersion.foo('plop')&quot;&gt;plop/span&gt;
            &lt;span onclick=&quot;CreateVersion.foo('prout')&quot;&gt;prout&lt;/span&gt;
        &lt;/label&gt;
        &lt;input
            id=&quot;CreateVersion_name&quot;
            name=&quot;CreateVersion[name]&quot;
            class=&quot;form-control version_name&quot;
            type=&quot;text&quot;
        /&gt;
    &lt;/div&gt;
    &lt;div class=&quot;form-group&quot;&gt;
        &lt;label&gt;
            &lt;span&gt;something something&lt;/span&gt;:
            &lt;span class=&quot;text_length&quot;&gt;0&lt;/span&gt;
        &lt;/label&gt;
        &lt;input
            id=&quot;CreateVersion_articleNotes&quot;
            name=&quot;CreateVersion[articleNotes]&quot;
            class=&quot;form-control&quot;
            type=&quot;text&quot;
        /&gt;
    &lt;/div&gt;
    &lt;hr/&gt;
    &lt;div&gt;
        &lt;button
            type=&quot;submit&quot;
            id=&quot;CreateVersion_submit&quot;
            name=&quot;CreateVersion[submit]&quot;
        &gt;
            submit
        &lt;/button&gt;
    &lt;/div&gt;
&lt;/form&gt;
</code></pre>

<h3 id="toc_2">Le erreur</h3>

<pre><code>TypeError: CreateVersion.foo is not a function
</code></pre>

<p>No, not in IE6, in last version of Firefox/Chrome</p>

<h3 id="toc_3">Le solution</h3>

<p>This line</p>

<pre><code>    &lt;form name=&quot;CreateVersion&quot; method=&quot;post&quot; action=&quot;&quot;&gt;
</code></pre>

<p>declare a Form with a name <code>CreateVersion</code> which is exactly the same name as our
Javascript module, and guess what ?</p>

<p>The name is exported in the DOM, which that when you do that</p>

<pre><code>&lt;form name=&quot;Foo&quot;&gt;
</code></pre>

<p>Then you can do</p>

<pre><code>document.Foo
</code></pre>

<p>to access to the DOM node, and in the HTML itself, the &ldquo;document&rdquo; is implicit which
mean that &ldquo;document.Foo&rdquo; collide with any javascript defined variable &ldquo;Foo&rdquo;</p>

<p>For more explanation see <a href="http://stackoverflow.com/questions/1415747/javascript-function-and-form-name-conflict">this stackoverflow question</a></p>

<h3 id="toc_4">How to avoid that:</h3>

<p>Some possibilities:</p>

<ul>
<li>Make it a coding style policy that module name start contains something &ldquo;javascript only&rdquo; like <code>FooModule</code> or <code>FooJS</code></li>
<li>put your modules in one big wrapping modules (like <code>MyCorp.Foo</code>)</li>
</ul>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://allan-simon.github.io/blog/posts/workflow-publishing-blog-post-with-hugo/">
        Workflow publishing blog post with hugo
      </a>
    </h1>

    <span class="post-date">Fri, Feb 20, 2015</span>

    <p>I&rsquo;ve added some functions in my shell to make it even more convenient
to write/edit/publish articles with <code>hugo</code> (just a self reminder)</p>

<p>so that now I have</p>

<ul>
<li>new_blog_post name-of-your-blog-post</li>
<li>publish_blog</li>
<li>edit_last_blog_post</li>
</ul>

<p>that can be run from anywhere in my terminal</p>

<pre><code>export BLOG_ROOT=~/git/perso/blog
export BLOG_THEME=hyde
export GITHUB=git@github.com:allan-simon/blog.git

function new_blog_post {
    cd $BLOG_ROOT
    LAST_BLOG_POST=$(hugo new posts/$1.md | cut -d &quot; &quot; -f 1) ;
    export LAST_BLOG_POST ;
    $EDITOR $LAST_BLOG_POST
    cd -
}

function publish_blog {
    cd $BLOG_ROOT;
    hugo --theme=&quot;$BLOG_THEME&quot; --buildDrafts &amp;&amp; \
    git add -A &amp;&amp;  \
    git commit -m &quot;Updating site&quot; &amp;&amp; \
    git push origin master &amp;&amp; \
    git subtree push --prefix=public $GITHUB gh-pages --squash  &amp;&amp; \
    echo &quot;published&quot;
    cd $BLOG_ROOT
}

function edit_last_blog_post {
    $EDITOR $LAST_BLOG_POST
}
</code></pre>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://allan-simon.github.io/blog/posts/functionnal-tests-symfony2-and-authentication/">
        Functionnal tests in symfony2 with authentication
      </a>
    </h1>

    <span class="post-date">Fri, Feb 20, 2015</span>

    <p>Let&rsquo;s say you have your symfony2 website, all setup correctly with its
set of functionnal tests using phpunit, and now you start to have
pages that only authenticated users can access to. My first solution was to
create a client, make it load the login form, submit some valid credentials
and then load the actual page to test. It was working fine as the client
has a storage for cookie, it is acting like an actual browser in that case.</p>

<p>The problem was that the time to execute the test was much longer, which
started to become a problem has the test suite was growing.</p>

<p>The first trick is to follow them method adviced by symfony, which is for the
test environnement to enable the HTTP Basic Authentication method. For those
who doesn&rsquo;t know, the HTTP standard comme with a method to authentify a
user-agent by directly sending the username/password in the HTTP header
(which goes along the fact that HTTP is aimed to be stateless)</p>

<p>in your <code>config_test.yml</code> add this (replace <code>NAME_OF_YOUR_FIREWALL</code>)</p>

<pre><code>security:
    firewalls:
        NAME_OF_YOUR_FIREWALL:
            http_basic: ~
</code></pre>

<p>The second trick, to not have to repeat the username/password in all your
functionnal tests, is to use the <a href="https://github.com/liip/LiipFunctionalTestBundle">LiipFunctionnalBundle</a>
follow the installation instruction and then make your functionnal test inherit
from their class, like this</p>

<pre><code>&lt;?php
//...
use Liip\FunctionalTestBundle\Test\WebTestCase;

class YourTest extends WebTestCase
{
 // your code
}
</code></pre>

<p>then you can precise in <code>config_test.yml</code> your credentials:</p>

<pre><code>liip_functional_test:
    authentication:
        username: &quot;XXXXX&quot;
        password: &quot;YYYYY&quot;
</code></pre>

<p>finally to create an authenticated client, use this method</p>

<pre><code>&lt;?php
//...
use Liip\FunctionalTestBundle\Test\WebTestCase;

class YourTest extends WebTestCase
{
    public testYourFeature()
    {
        // true = &quot;authenticated&quot;
        $client static::makeClient(true);
        // ...
    }
}
</code></pre>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://allan-simon.github.io/blog/posts/solve-composer-github-api-limitation/">
        Solve composer github api limitation
      </a>
    </h1>

    <span class="post-date">Tue, Feb 10, 2015</span>

    

<h3 id="toc_0">Could not fetch X enter your GitHub credentials to go over the API rate limit</h3>

<p>The problem is that composer is retrieving nearly all the packages from github
using the anonymous access github API. In order to solve it you need to generate
a token</p>

<ol>
<li>you need a github account (or ask a friend)</li>
<li>go on your setting page <a href="https://github.com/settings/applications">here</a></li>
<li>click on <code>Generate new token</code></li>
</ol>

<p>now two possibilities</p>

<h4 id="toc_1">1 - Put this token in one specific project</h4>

<p>for this simply run</p>

<pre><code>composer config -g github-oauth.github.com YOUR_TOKEN
</code></pre>

<p>or</p>

<pre><code>php composer.phar config -g github-oauth.github.com YOUR_TOKEN
</code></pre>

<p>(depending on how you installed composer)</p>

<p>it will add that to your project&rsquo;s composer.json file</p>

<h4 id="toc_2">2 -  Put this token in your global composer configuration</h4>

<p>If your project is an open-source or company project you may not want
to commit your token on the git of your project/company</p>

<p>for this edit the file <code>~/.composer/config.json</code> and put in it:</p>

<pre><code>{
    &quot;config&quot;: {
        &quot;github-oauth&quot;: { &quot;github.com&quot;: &quot;YOUR_TOKEN&quot; }
    }
}
</code></pre>

<p>that&rsquo;s all folks!</p>

<p>Source:</p>

<ul>
<li><a href="https://coderwall.com/p/kz4egw/composer-install-github-rate-limiting-work-around">coderwall.com</a></li>
<li><a href="https://github.com/composer/composer/issues/3542">composer&rsquo;s github</a></li>
<li><a href="https://github.com/blog/1509-personal-api-tokens">github&rsquo;s blog</a> More details about Github token</li>
</ul>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://allan-simon.github.io/blog/posts/install-docker-on-ubuntu-12.04/">
        Install docker on ubuntu 12.04
      </a>
    </h1>

    <span class="post-date">Tue, Feb 10, 2015</span>

    <p>This article is a shameless summary from <a href="http://compositecode.com/2013/11/11/getting-docker-installed-on-ubuntu-12-04-lts/">http://compositecode.com</a></p>

<p>the steps are:</p>

<ul>
<li>Updating your kernel to 3.8+ (requires a reboot)</li>
<li>Add the docker repository</li>
<li>Installing the package</li>
</ul>

<pre><code>sudo apt-get install linux-image-generic-lts-raring linux-headers-generic-lts-raring
sudo reboot
sudo sh -c &quot;wget -qO- https://get.docker.io/gpg | apt-key add -&quot;
sudo sh -c &quot;echo deb http://get.docker.io/ubuntu docker main &gt; /etc/apt/sources.list.d/docker.list&quot;
sudo apt-get update
sudo apt-get install lxc-docker
</code></pre>

<p>And now you should be able to get docker working</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://allan-simon.github.io/blog/posts/postgresql-display-one-column-per-line/">
        postgresql display one column per line
      </a>
    </h1>

    <span class="post-date">Tue, Feb 10, 2015</span>

    

<h3 id="toc_0">Problem : displaying a table with a lot of columns</h3>

<p>You always got that table with a dozens of columns of type text and for which
the normal tabular output does not work nicely and you end up with something
like</p>

<pre><code> articleid | plop | pouet | prout | tagada |  id   | newsid  | newstype |                                                          title                                                          | something | something | something | something | something | something | something | something |      something       |      something       | something | something | something | something |          something          |    something    |                                                                                                                                                                                                                                                                                                                 something                                                                                                                                                                                                                                                                                                                 |            something            
-----------+-------+-------+-------+-------+-------+---------+----------+-----------------------------------------------------------------------------------------------------------------------------+------------+-------------+-----------+------------+-----------------+---------+--------------+---------+---------------------+---------------------+---------------+-------------+-----------+------------+---------------------------+-----------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------------------+------------+--------------------------------+--------------+----------------------+------------------------------------------------------------------------------------+--------------+-----------+----------+----------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+-----------+-------+------------
   1000163 |     0 |     0 |     0 |     0 |   141 | 1000147 |       10 | blablabla                                                                                           |          3 |           4 |        22 |    1000163 |               0 | 1000163 |          184 |   10028 | 2014-06-30 23:36:00 | 2014-06-30 23:36:00 |             0 |           0 |         0 |          0 |                           |           |          
</code></pre>

<h3 id="toc_1">In MySQL</h3>

<p>with MySQL you can replace <code>;</code> by <code>\G</code> at the end of your SQL statement, i.e turning</p>

<pre><code>SELECT * FROM example ;
</code></pre>

<p>into</p>

<pre><code>SELECT * FROM example \G
</code></pre>

<h3 id="toc_2">In PostgreSQL</h3>

<p>you need first to use <code>\x</code> and it will activate the &lsquo;one column by line&rsquo; display
(use <code>\x</code> again to switch back to normal mode)</p>

<pre><code>\x
SELECT * FROM example;
\x
</code></pre>

<p>and you will something like that</p>

<pre><code>-[ RECORD 1 ]------
articleid | 1000000
something     | 0
something     | 0
something     | 0
something     | 0
id        | 1
-[ RECORD 2 ]------
articleid | 1000002
something     | 0
something     | 0
something     | 0
something     | 0
something     | 2
</code></pre>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://allan-simon.github.io/blog/posts/first/">
        A new Blog this time on github and statically generated
      </a>
    </h1>

    <span class="post-date">Mon, Feb 9, 2015</span>

    <p>It has been a long time since I last did a blog the biggest reason behind were:</p>

<ul>
<li>it&rsquo;s hard to maintain a server and a blog platform</li>
<li>most common web plateforms are blocked in China</li>
<li>the other plateforms does not fit my geeky needs</li>
<li>non-self hosted platform make it hard to have easy backup of your data</li>
</ul>

<p>So here we are, after reading comments on HackerNews I&rsquo;ve found the project
<a href="http://gohugo.io">Hugo</a> which permits you to create a static blog the
advantages I see to it</p>

<ul>
<li>it&rsquo;s all command line and simple to install</li>
<li>vim and markdown friendly, posting is just one more markdown file</li>
<li>can be hosted on github (which solve the hosting problem)</li>
<li>it&rsquo;s text files and git (which solve the backup problem)</li>
</ul>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://allan-simon.github.io/blog/about/">
        about
      </a>
    </h1>

    <span class="post-date">Mon, Feb 9, 2015</span>

    

<h2 id="toc_0">What will you find on this blog</h2>

<ul>
<li>My daily discoveries and tips, mostly web/linux/devops/c++/c/rust related.</li>
<li>Some tips and tricks on how to survive in the Chinese internet as a devops</li>
<li>Some news concerning my personnal projects</li>
<li>Random thoughts as I progress in my professional and personnal career.</li>
</ul>

  </div>
  
</div>
</div>
<script src="https://yandex.st/highlightjs/8.0/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

</body>
</html>
